
from IPython.display import HTML

html = r"""
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Black–Scholes Options Visualizer</title>
<style>
  :root { --bg:#0b0d11; --panel:#12151b; --ink:#e8ebf0; --muted:#9aa2b1; --accent:#9ad1ff; --grid:#2a2f3a;}
  html, body { background: var(--bg); color: var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0;}
  .wrap { max-width: 1120px; margin: 0 auto; padding: 24px 16px 48px; }
  h1 { font-size: 22px; margin: 0 0 6px 0; }
  h2 { font-size: 16px; margin: 22px 0 8px 0; }
  p.sub { color: var(--muted); margin-top: 0; }
  .grid { display: grid; grid-template-columns: 320px 1fr; gap: 18px; align-items: start; }
  .panel { background: var(--panel); border: 1px solid var(--grid); border-radius: 10px; padding: 14px; }
  .controls .row { display: grid; grid-template-columns: 1fr 64px; gap: 10px; align-items: center; margin: 9px 0; }
  .controls label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px;}
  .controls input[type=range] { width: 100%; }
  .controls input[type=number] { width: 100%; background: #0f1217; border: 1px solid var(--grid); color: var(--ink); border-radius: 6px; padding: 6px 8px; }
  .controls .inline { display:flex; gap:10px; }
  .tag { font-size: 11px; color: var(--muted); }
  canvas { width: 100%; height: 420px; background: #0f1217; border-radius: 10px; border: 1px solid var(--grid); }
  .legend { display:flex; gap:16px; font-size:12px; color: var(--muted); margin-top:6px; flex-wrap: wrap; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .btns { display:flex; gap:8px; flex-wrap: wrap; }
  .btn { background:#0f1217; border:1px solid var(--grid); color:var(--ink); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
  .btn.active { outline: 2px solid var(--accent); }
  .row2 { display:grid; grid-template-columns: repeat(2, 1fr); gap:18px; }
  .small { font-size: 12px; color: var(--muted); }
  a, a:visited { color: var(--accent); }
</style>
</head>
<body>
<div class="wrap">
  <h1>Black–Scholes Options Visualizer</h1>
  <p class="sub">Play with IV and DTE to see the Greeks (Δ, Γ, Θ) and the P&amp;L move. Uses European-style Black–Scholes. Educational only.</p>

  <div class="grid">
    <div class="panel controls">
      <div class="row">
        <div>
          <label>Underlying price (S₀)</label>
          <input id="S0" type="number" step="0.01" value="100">
        </div>
        <div>
          <label>Strike (K)</label>
          <input id="K" type="number" step="0.01" value="100">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Implied Volatility (IV, %)</label>
          <input id="IV" type="range" min="1" max="250" value="20">
        </div>
        <div><span id="IVv" class="tag">20%</span></div>
      </div>
      <div class="row">
        <div>
          <label>Days to Expiry (DTE)</label>
          <input id="DTE" type="range" min="1" max="365" value="30">
        </div>
        <div><span id="DTEv" class="tag">30d</span></div>
      </div>
      <div class="row">
        <div>
          <label>Risk-free rate (r, %)</label>
          <input id="r" type="range" min="-5" max="10" value="0">
        </div>
        <div><span id="rv" class="tag">0.00%</span></div>
      </div>

      <div class="row">
        <div>
          <label>Price range around S₀ (±%)</label>
          <input id="rangePct" type="range" min="5" max="200" value="50">
        </div>
        <div><span id="rangePctv" class="tag">±50%</span></div>
      </div>
      <div class="row">
        <div>
          <label>Steps</label>
          <input id="steps" type="range" min="50" max="800" value="400">
        </div>
        <div><span id="stepsv" class="tag">400</span></div>
      </div>

      <div class="row">
        <div class="inline">
          <div class="btns" id="otype">
            <button class="btn active" data-val="call">Call</button>
            <button class="btn" data-val="put">Put</button>
          </div>
          <div class="btns" id="side">
            <button class="btn active" data-val="long">Long</button>
            <button class="btn" data-val="short">Short</button>
          </div>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div class="inline">
          <label><input type="checkbox" id="normGT"> Normalize Γ &amp; Θ to [-1, 1]</label>
        </div>
        <div></div>
      </div>

      <div class="small">Notes: Δ is clipped to [-1, 1]. Θ is shown per day. Vertical line on the charts marks the strike (K). Gridlines at y = −1, 0, +1 help compare shapes. Greeks reflect Long/Short selection (Γ flips sign if short).</div>
    </div>

    <div class="panel">
      <h2>Greeks vs. Underlying Price</h2>
      <canvas id="greeks" width="900" height="420"></canvas>
      <div class="legend">
        <span><span class="dot" style="background:#ffffff"></span>Δ (delta)</span>
        <span><span class="dot" style="background:#4da3ff"></span>Γ (gamma)</span>
        <span><span class="dot" style="background:#9aa2b1"></span>Θ/day (theta)</span>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:18px;">
    <h2>P&amp;L vs. Underlying Price</h2>
    <canvas id="pnl" width="1100" height="420"></canvas>
    <div class="legend">
      <span><span class="dot" style="background:#73e897"></span>P&amp;L (per option)</span>
    </div>
  </div>

  <p class="small">Black–Scholes assumptions: European exercise, constant IV, frictionless markets, no dividends (dividend yield q = 0). For education only — not investment advice.</p>
</div>

<script>
(function(){
  function erf(x){
    const sign = (x>=0)?1:-1;
    x = Math.abs(x);
    const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429, p=0.3275911;
    const t = 1/(1+p*x);
    const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
    return sign*y;
  }
  function phi(x){ return Math.exp(-0.5*x*x)/Math.sqrt(2*Math.PI); }
  function N(x){ return 0.5*(1+erf(x/Math.SQRT2)); }

  function bs(S,K,T,sig,r,otype){
    const sqrtT = Math.sqrt(Math.max(T,1e-12));
    const d1 = (Math.log(S/K) + (r + 0.5*sig*sig)*T)/(sig*sqrtT);
    const d2 = d1 - sig*sqrtT;
    let price, delta, gamma, theta;
    if(otype==='call'){
      price = S*N(d1) - K*Math.exp(-r*T)*N(d2);
      delta = N(d1);
      theta = (-S*phi(d1)*sig/(2*sqrtT)) - r*K*Math.exp(-r*T)*N(d2); // per year
    }else{
      price = K*Math.exp(-r*T)*N(-d2) - S*N(-d1);
      delta = N(d1) - 1; // = -N(-d1)
      theta = (-S*phi(d1)*sig/(2*sqrtT)) + r*K*Math.exp(-r*T)*N(-d2); // per year
    }
    gamma = phi(d1)/(S*sig*sqrtT);
    return {price, delta, gamma, theta};
  }

  function $id(s){ return document.getElementById(s); }

  const dom = {
    S0:$id('S0'), K:$id('K'),
    IV:$id('IV'), IVv:$id('IVv'),
    DTE:$id('DTE'), DTEv:$id('DTEv'),
    r:$id('r'), rv:$id('rv'),
    rangePct:$id('rangePct'), rangePctv:$id('rangePctv'),
    steps:$id('steps'), stepsv:$id('stepsv'),
    otype:$id('otype'), side:$id('side'),
    normGT:$id('normGT'),
    canvGreeks:$id('greeks'), canvPNL:$id('pnl'),
  };

  function pick(btns, val){
    [...btns.querySelectorAll('.btn')].forEach(b=>{
      b.classList.toggle('active', b.dataset.val===val);
    });
  }
  function getPick(btns){
    const b = [...btns.querySelectorAll('.btn')].find(x=>x.classList.contains('active'));
    return b? b.dataset.val : null;
  }
  dom.otype.addEventListener('click', e=>{
    if(e.target.classList.contains('btn')){
      pick(dom.otype, e.target.dataset.val);
      drawAll();
    }
  });
  dom.side.addEventListener('click', e=>{
    if(e.target.classList.contains('btn')){
      pick(dom.side, e.target.dataset.val);
      drawAll();
    }
  });

  const inputs = [dom.S0, dom.K, dom.IV, dom.DTE, dom.r, dom.rangePct, dom.steps, dom.normGT];
  inputs.forEach(el=>{
    el.addEventListener('input', ()=>{
      dom.IVv.textContent = dom.IV.value + '%';
      dom.DTEv.textContent = dom.DTE.value + 'd';
      dom.rv.textContent = (+dom.r.value).toFixed(2) + '%';
      dom.rangePctv.textContent = '±' + dom.rangePct.value + '%';
      dom.stepsv.textContent = dom.steps.value;
      drawAll();
    });
  });

  function genX(S0, pct, steps){
    const lo = S0*(1 - pct/100), hi = S0*(1 + pct/100);
    const xs = new Array(steps);
    for(let i=0;i<steps;i++){
      xs[i] = lo + (hi-lo)*i/(steps-1);
    }
    return {xs, lo, hi};
  }

  function computeSeries(){
    const S0 = Math.max(1e-8, +dom.S0.value);
    const K  = Math.max(1e-8, +dom.K.value);
    const sig = Math.max(0.0001, +dom.IV.value/100);
    const T = Math.max(1e-9, +dom.DTE.value/365);
    const r = (+dom.r.value)/100;
    const {xs, lo, hi} = genX(S0, +dom.rangePct.value, +dom.steps.value);
    const ttype = getPick(dom.otype);
    const longShort = getPick(dom.side)==='long' ? 1 : -1;

    let delta=[], gamma=[], thetaDay=[], prices=[];
    for(let i=0;i<xs.length;i++){
      const S = xs[i];
      const g = bs(S,K,T,sig,r,ttype);
      delta.push(g.delta);
      gamma.push(g.gamma);
      thetaDay.push(g.theta/365); // per day
      prices.push(g.price);
    }

    // Position greeks: flip sign if short
    if(longShort===-1){
      delta = delta.map(v=>-v);
      gamma = gamma.map(v=>-v);
      thetaDay = thetaDay.map(v=>-v);
    }

    // Delta is clipped for display only
    delta = delta.map(v=> Math.max(-1, Math.min(1, v)));

    const premNow = bs(S0,K,T,sig,r,ttype).price;
    let pnl = prices.map(p=> longShort*(p - premNow));

    return {S0, K, sig, T, r, xs, lo, hi, delta, gamma, thetaDay, pnl};
  }

  function drawAxes(ctx, W, H, lo, hi, yLo, yHi){
    ctx.fillStyle = '#0f1217';
    ctx.fillRect(0,0,W,H);
    const L=54, R=18, T=18, B=32;
    ctx.strokeStyle = '#2a2f3a'; ctx.lineWidth = 1;
    ctx.beginPath();
    for(let gx=0; gx<=10; gx++){
      const x = L + (W-L-R)*gx/10;
      ctx.moveTo(x, T); ctx.lineTo(x, H-B);
    }
    for(let gy=0; gy<=10; gy++){
      const y = T + (H-T-B)*gy/10;
      ctx.moveTo(L, y); ctx.lineTo(W-R, y);
    }
    ctx.stroke();

    ctx.fillStyle = '#9aa2b1';
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign='center'; ctx.textBaseline='top';
    for(let gx=0; gx<=10; gx++){
      const t = gx/10, S = lo + (hi-lo)*t;
      const x = L + (W-L-R)*t;
      ctx.fillText(S.toFixed(2), x, H-24);
    }
    ctx.textAlign='right'; ctx.textBaseline='middle';
    for(let gy=0; gy<=10; gy++){
      const t = gy/10, val = yHi - (yHi-yLo)*t;
      const y = T + (H-T-B)*t;
      ctx.fillText(val.toFixed(2), L-6, y);
    }
    return {
      L,R,T,B,
      xPix:(S)=> L + (W-L-R)*( (S-lo)/(hi-lo) ),
      yPix:(v)=> T + (H-T-B)*(1 - ( (v-yLo)/(yHi-yLo) )),
    };
  }

  function drawGreeks(){
    const ctx = dom.canvGreeks.getContext('2d');
    const W = dom.canvGreeks.width, H=dom.canvGreeks.height;

    const st = computeSeries();

    let yLo=-1, yHi=1;
    const norm = dom.normGT.checked;
    let gamma = st.gamma.slice();
    let theta = st.thetaDay.slice();
    if(norm){
      const gMax = Math.max(1e-12, ...gamma.map(Math.abs));
      const tMax = Math.max(1e-12, ...theta.map(Math.abs));
      gamma = gamma.map(v => Math.max(-1, Math.min(1, v/gMax)));
      theta = theta.map(v => Math.max(-1, Math.min(1, v/tMax)));
    }else{
      const minV = Math.min(-1, ...gamma, ...theta, ...st.delta);
      const maxV = Math.max( 1, ...gamma, ...theta, ...st.delta);
      yLo = Math.max(-10, minV);
      yHi = Math.min( 10, maxV);
    }

    const ax = drawAxes(ctx, W,H, st.lo, st.hi, yLo, yHi);

    // strike marker
    ctx.strokeStyle = '#444c59'; ctx.setLineDash([4,4]);
    const xK = ax.xPix(st.K);
    ctx.beginPath(); ctx.moveTo(xK, ax.T); ctx.lineTo(xK, H-ax.B); ctx.stroke();
    ctx.setLineDash([]);

    function drawLine(xs, arr, color){
      ctx.strokeStyle = color; ctx.lineWidth=2; ctx.beginPath();
      for(let i=0;i<xs.length;i++){
        const x=ax.xPix(xs[i]), y=ax.yPix(arr[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    // y = -1, 0, +1 lines
    const refs=[-1,0,1];
    ctx.strokeStyle = '#2f3542'; ctx.lineWidth=1; ctx.setLineDash([2,4]);
    ctx.beginPath();
    refs.forEach(v=>{ const y=ax.yPix(v); ctx.moveTo(ax.L,y); ctx.lineTo(W-ax.R,y); });
    ctx.stroke();
    ctx.setLineDash([]);

    drawLine(st.xs, st.delta, '#ffffff'); // delta
    drawLine(st.xs, gamma, '#4da3ff');    // gamma
    drawLine(st.xs, theta, '#9aa2b1');    // theta/day
  }

  function drawPNL(){
    const ctx = dom.canvPNL.getContext('2d');
    const W = dom.canvPNL.width, H=dom.canvPNL.height;

    const st = computeSeries();
    const lo = Math.min(...st.pnl), hi = Math.max(...st.pnl);
    const pad = 0.08 * Math.max(1, Math.abs(hi-lo));
    let yLo = lo - pad, yHi = hi + pad;
    if(Math.abs(yHi - yLo) < 1e-8){ yLo -= 1; yHi += 1; }

    const ax = drawAxes(ctx, W,H, st.lo, st.hi, yLo, yHi);

    // strike marker
    ctx.strokeStyle = '#444c59'; ctx.setLineDash([4,4]);
    const xK = ax.xPix(st.K);
    ctx.beginPath(); ctx.moveTo(xK, ax.T); ctx.lineTo(xK, H-ax.B); ctx.stroke();
    ctx.setLineDash([]);

    // zero line
    ctx.strokeStyle = '#2f3542'; ctx.lineWidth=1; ctx.setLineDash([2,4]);
    ctx.beginPath(); const y0=ax.yPix(0); ctx.moveTo(ax.L,y0); ctx.lineTo(W-ax.R,y0); ctx.stroke();
    ctx.setLineDash([]);

    // pnl
    ctx.strokeStyle = '#73e897'; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<st.xs.length;i++){
      const x=ax.xPix(st.xs[i]), y=ax.yPix(st.pnl[i]);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function drawAll(){ drawGreeks(); drawPNL(); }
  drawAll();
})();
</script>
</body>
</html>
"""

path = "/mnt/data/black_scholes_visualizer.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)

HTML(html)
